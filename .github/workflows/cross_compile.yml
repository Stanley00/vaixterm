name: Build and Package VaixTerm

on:
  push:
    branches: ["main"]
    tags:
      - 'v*' # Push events matching v1.0, v20.15.10, etc.
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    # Allow manual triggering of the workflow

env:
  SDK_URL: https://github.com/joyrider3774/sdks/releases/download/v1.0/aarch64-buildroot-linux-gnu_sdk-buildroot.tar.gz 
  SDK_DIR: ${{ github.workspace }}/rg35xx-toolchain
  BUILDROOT_HOST_DIR: ${{ github.workspace }}/rg35xx-toolchain/usr
  ARTIFACT_PREFIX: vaixterm-rg35xxh-aarch64
  VERSION: ${{ github.ref_name && startsWith(github.ref, 'refs/tags/') && github.ref_name || 'dev' }}

jobs:
  build:
    name: Build for RG35XXH
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up environment
      run: |
        # Create toolchain directory
        mkdir -p ${SDK_DIR}
        
        # Download and extract the SDK
        echo "Downloading SDK..."
        wget ${SDK_URL} -O sdk.tar.gz
        tar -xzf sdk.tar.gz -C ${SDK_DIR} --strip-components=1
        
        # Fix permissions
        chmod -R u+w ${SDK_DIR}
        
        # Run the SDK's relink script if it exists
        if [ -f "${SDK_DIR}/relocate-sdk.sh" ]; then
          echo "Relocating SDK..."
          ${SDK_DIR}/relocate-sdk.sh
        fi
        
        # Verify the toolchain is accessible
        if [ ! -f "${BUILDROOT_HOST_DIR}/bin/aarch64-buildroot-linux-gnu-gcc" ]; then
          echo "Error: Toolchain not found"
          ls -la ${BUILDROOT_HOST_DIR}/bin/
          exit 1
        fi
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y file build-essential pkg-config libsdl2-dev libsdl2-ttf-dev libsdl2-image-dev zip
    
    - name: Build VaixTerm
      run: |
        # Set environment variables for cross-compilation
        export PATH="${BUILDROOT_HOST_DIR}/bin:${PATH}"
        export BUILDROOT_HOST_DIR="${BUILDROOT_HOST_DIR}"
        
        # Build the project
        make clean
        make all
        
        # Verify the binary
        file vaixterm || true
        
        # Create release directory
        mkdir -p release
        cp vaixterm release/
        cp -r res/ release/
        
        # Create a tar.gz of the release
        tar -czvf ./packages/${{ env.ARTIFACT_PREFIX }}.tar.gz -C release .
    
    - name: Create Packages
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      run: |
        ./packages/build_portmaster.sh
        ./packages/build_muos.sh
        
        # List files for debugging
        mv packages/VaixTerm.muxapp packages/${{ env.ARTIFACT_PREFIX }}.muxapp
        mv packages/VaixTerm-PortMaster.zip packages/${{ env.ARTIFACT_PREFIX }}.zip
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vaixterm-artifacts
        path: |
          packages/${{ env.ARTIFACT_PREFIX }}.tar.gz
          packages/${{ env.ARTIFACT_PREFIX }}.zip
          packages/${{ env.ARTIFACT_PREFIX }}.muxapp
        retention-days: 5
        if-no-files-found: error
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: |
          packages/${{ env.ARTIFACT_PREFIX }}.tar.gz
          packages/${{ env.ARTIFACT_PREFIX }}.zip
          packages/${{ env.ARTIFACT_PREFIX }}.muxapp
        body: |
          # VaixTerm ${{ env.VERSION }}
          
          ## Downloads
          - **Raw Binary**: [${{ env.ARTIFACT_PREFIX }}.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.ARTIFACT_PREFIX }}.tar.gz)
          - **PortMaster Package**: [${{ env.ARTIFACT_PREFIX }}.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.ARTIFACT_PREFIX }}.zip)
          - **MUOS Package**: [${{ env.ARTIFACT_PREFIX }}.muxapp](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.ARTIFACT_PREFIX }}.muxapp)
          
          ## Installation Instructions
          
          ### Manual Installation
          1. Extract the `${{ env.ARTIFACT_PREFIX }}.tar.gz` to your SD card
          2. Make the binary executable: `chmod +x vaixterm`
          3. Run: `./vaixterm`
          
          ### PortMaster Installation
          1. Copy the `${{ env.ARTIFACT_PREFIX }}.zip` to the `ports` directory on your SD card (typically in the `roms/ports` or `roms2/ports` directory)
          2. Launch PortMaster from your device's app launcher
          3. Navigate to the "Ready to Install" section
          4. Select VaixTerm and follow the on-screen instructions
          
          ### MUOS Installation
          1. Copy the `${{ env.ARTIFACT_PREFIX }}.muxapp` file to the root of your SD card
          2. On your device, go to: `Apps` > `Archive`
          3. Select the `.muxapp` file to install it
          4. The terminal will be available in the `Apps` section of your MUOS launcher
          
          ## Notes
          - For MUOS, ensure you have the latest version of the firmware installed
          - On some devices, you may need to restart the device after installing new applications
          - Check the [GitHub repository](https://github.com/${{ github.repository }}) for additional documentation and support
          
          Built from ${{ github.sha }}
